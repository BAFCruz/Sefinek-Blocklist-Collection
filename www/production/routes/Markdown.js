const express=require("express"),router=express.Router(),autoIndex=require("express-autoindex"),path=require("node:path"),fs=require("node:fs/promises"),{version:version}=require("../../../package.json"),options={customTemplate:path.join(__dirname,"..","views","autoindex","markdown.html"),dirAtTop:!0},Marked=require("marked");Marked.use({pedantic:!1,gfm:!0});const TITLE_REGEX=/\* Title\s+:\s+(.*)/,DESC_REGEX=/\* Description\s+:\s+(.*)/,TAGS_REGEX=/\* Tags\s+:\s+(.*)/,CANONICAL_REGEX=/\* Canonical\s+:\s+(.*)/,convertUrls=e=>(/\/viewer\//.test(e)&&(e=e.replace(/%20/g,"_").replace(".md","")),e),isValidName=e=>/^[a-zA-Z0-9_-]+$/.test(e),isPathSecure=e=>!e.includes("..")&&!e.includes("//")&&!e.includes("\\");router.get("/markdown",((e,s)=>s.render("markdown.ejs",{version:version}))),router.use("/markdown/lists",autoIndex(path.join(__dirname,"..","..","docs","lists"),options)),router.use("/markdown/info",autoIndex(path.join(__dirname,"..","..","docs","info"),options)),router.use("/markdown/tutorials",autoIndex(path.join(__dirname,"..","..","docs","tutorials"),options));const pages=["Abuse","Advertising","AMP_Hosts","Block_websites_and_games","CryptoJacking","Dating_services","Drugs","Fake_news","Gambling","Hate_and_junk","Malicious","Phishing","Piracy","Porn","Ransomware","Redirect","Scam","Spam_mails","Spyware","Telemetry_and_Tracking","Useless_websites","YouTube_and_mobile_ads_etc.","Norton.txt","What_is_Pi-hole","What_is_Raspberry_Pi","What_is_Regex","Why_should_I_block_LoL","Why_should_I_block_Omegle","Why_should_I_block_Riot_Games","Why_should_I_block_Snapchat","Why_should_I_block_TikTok","Why_should_I_block_Valorant","How_to_install_Pi-hole","How_to_install_Unbound_for_Pi-hole"];router.use("/viewer/:category",(async(e,s)=>{const{category:t}=e.params,r=e.url.replace(`/viewer/${t}`,"").replace(/_/g," ").replace(/\.md/,"").replace(/%20/g," "),a=e.url.split("/").pop();if(!(o=a,/^[a-zA-Z0-9_-]+$/.test(o)&&pages.includes(a)))return s.sendStatus(404);var o,i;if(!isPathSecure(r))return s.sendStatus(404);if(r.endsWith(".txt"))return s.redirect(`/docs/${t}/${r}`);try{const e=path.join(__dirname,"..","..","docs",t,`${r}.md`);if(!e.startsWith(path.join(__dirname,"..","..","docs",t)))return s.sendStatus(403);if(!(await fs.lstat(e)).isFile())return s.sendStatus(404);const a=await fs.readFile(e,"utf8");s.render("markdown-viewer.ejs",{html:Marked.parse((i=a,/\/viewer\//.test(i)&&(i=i.replace(/%20/g,"_").replace(".md","")),i)),title:a.match(TITLE_REGEX)?a.match(TITLE_REGEX)[1]:"Unknown title",desc:a.match(DESC_REGEX)?a.match(DESC_REGEX)[1]:void 0,tags:a.match(TAGS_REGEX)?a.match(TAGS_REGEX)[1]:void 0,canonical:a.match(CANONICAL_REGEX)?a.match(CANONICAL_REGEX)[1].trim():void 0})}catch(e){console.error(e),s.sendStatus(500)}})),module.exports=router;